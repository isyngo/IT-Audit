## 3.2 编号连续性分析

2020年2月1日凌晨著名做空机构浑水发布了做空瑞幸报告，报告中指出其线下门店采用随机数虚增订单，即门店的取餐码不是连续的而是有跳号。这样一种编号在系统中一般都是一个自增的字段，每增加一条数据编号都自动增加，因此是连续的。所以一般我们不会去关注这个编号连续性的问题，当然如果不连续的时候，稍微留心看一下编号，也很容易察觉。既然，有了这种编号不连续的案例，那么我们也就来尝试用SQL语句查找所有不连续的编号。

我们将随书附件中本节的《sales》表导入数据库中，数据仅包含一个字段id，我们需要查找出所以跳号的编号。一般来说，编号可能是纯数字，也可能有一些字母前缀。对于有字母前缀的数据我们需要先将前缀去掉：

```sql
update sales set 列名=replace(列名,'前缀','');
```

我们使用update修改表中的编号的值，`replace(列名,'替换前','替换后')`函数可以对文本进行替换。假如我们编号id里有前缀‘C’，那么我们可以使用`update sales set InvoiceNo=replace(InvoiceNo,'C','');`将前缀全部去掉。现在我们的编号id就是纯数字了。

```sql
select id+1
from sales a
where not exists (select * from sales b where b.id=a.id+1)
and id < (select max(id) from sales);
```

执行后结果显示所有跳号单号，如果需要运用到其他表中，只需要将id修改为自己的编号字段名称，sales修改为自己的表名。

`not exists (select * from sales b where b.id=a.id+1)`该条件为对于id，其下一个编号id+1不存在，说明这个id+1就是我们要找的跳号，而`select id+1`我们就能将这样的跳号筛选出来。

`id < (select max(id) from sales)`该条件是限制id不超过编号的最大值，如果不加该限制最大的编号就会被认定为是跳号，因为id+1一定是不存在的。

很多时候SQL只是一个工具，具体能用它能做什么需要我们自己去思考和设计，也就是说在数据分析中真正困难的是我们拥有的想法，知道如何去思考，如何去解决问题。例如，除了上述方式外，我们还可以自己构建一个编号从最小编号到最大编号的连续编号的表，用这张连续编号的表与需要测试的表利用`join`连接，查找出跳号的单号。总之，解决方法不只有一种，具体问题可以自己多分析思考。

