## 2.6 SQL查询

上节我们完成了SQL最基本的查询语句学习，本节我们仍以2.3节导入的ecommerce表作为练习，进一步运用。读者也可以通过网站[sqlzoo.net](https://sqlzoo.net/wiki/SELECT_basics)完成更多的练习，能够尽快掌握基本的SQL用法。

**练习1**

从ecommerce表中筛选出United Kingdom、France、Australia、Germany四个国家的销售订单。

```SQL
select * from ecommerce
where Country in ('United Kingdom','France','Australia','Germany')
```

**练习2**

从ecommerce表中筛选出销售单价（UnitPrice）大于1万的订单，结果展示发票号（InvoiceNo），销售额（UnitPrice*Quantity）。

```SQL
select InvoiceNo,UnitPrice*Quantity as sales
from ecommerce
where UnitPrice>=10000;
```

**练习3**

从ecommerce表中筛选出退货订单（Quantity数量小于0），结果展示发票号（InvoiceNo），数量。

```sql
select InvoiceNo,Quantity
from ecommerce
where Quantity<0;
```

**练习4**

从ecommerce表中筛选出数量（Quantity）大于1万或者单价（UnitPrice）大于1万的订单。

```sql
select *
from ecommerce
where Quantity>10000 or UnitPrice>10000
```

**练习5**

在ecommerce表中计算国家（Country）为法国（France）的销售额合计数，合计数单位转换为万欧元，且保留两位小数。结果展示国家和销售额两个字段。

```sql
select Country,round(sum(UnitPrice*Quantity)/10000,2) as sales
from ecommerce
where Country='France'
```

解释：我们用`sum`函数求销售额合计数，通过除以10000，将单位由欧元转换为万欧元。上一节我们学过`format`和`convert`函数可以实现让数字类型保留两位小数。这里我们使用`round(数字,位数)`函数同样可以让数字类型四舍五入保留两位小数，最后用`as`将该计算结果字段命名为别名sales。

**练习6**

从ecommerce表中筛选出商品描述（Description）中包含'game'字样的订单。

```sql
select * from ecommerce
where Description like '%game%'
```

**练习7**

在ecommerce表中，查找出所有以'A'开头的国家（Country）。

```
select distinct Country
from ecommerce
where Country like 'a%'
```

**练习8**

在ecommerce表中，查找出国家（Country）名称字符长度最大的国家（注：使用length函数）。

```sql
select distinct Country
from ecommerce
order by length(Country) desc
limit 1
```

解释：`length()`函数是求字符串的长度的文本函数，通过用`order by`将表按国家名称的字符长度由大到小排序，再用`limit 1`截取第一个作为返回结果，就是我们需求找的字符长度最大的国家名称。

在MySQL中有很多文本函数，可以参考[MySQL官方文档](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html)，我们在学习的过程中不用一次性将所有的函数都记住，可以遇到问题了再查阅，检索，这样常用的函数随着出现频率的增加，自然会记住。

| 常用文本函数                 | 说明                                  |
| ---------------------------- | ------------------------------------- |
| left(str,len)                | 返回str文本中前len位字符              |
| right(str,len)               | 返回str文本中后len位字符              |
| mid(str,pos,len)             | 返回str文本中从pos位开始，后len位字符 |
| length(str)                  | 返回str文本字符数                     |
| concat(s1,s2,...)            | 拼接s1,s2,...字符串                   |
| trim(str)                    | 去除str文本的首尾空格                 |
| replace(str,from_str,to_str) | 将str文本中的from_str替换为to_str     |
| substring(str,pos)           | 返回str文本第pos位之后的文本          |
| upper(str)                   | 将str文本转换为大写                   |
| lower(str)                   | 将str文本转换为小写                   |

以上文本函数较为常用，读者可以利用ecommerce表自己测试运用一下。例如，InvoiceDate字段我们在之前数据导入的时候，设置的数据类型为varchar文本类型，没有设置成日期/时间类型，均是“12/1/2010 8:26”这样的格式。如果我想提取出“年份”，那么可以用`mid`函数：

```sql
select mid(InvoiceDate,6,4) from ecommerce
```

上面8个练习题都是简单的查询语句，可以检验自己是否对基本的SQL查询语句是否掌握。在实际项目中，我们进行数据分析，有时会写一些稍微复杂的语句，而这些“复杂”的语句也是由这些简单语句的组合成的，仅仅是将某一个条件、字段或表替换成简单语句而已。

**练习9**

在ecommerce表中，求销售额（UnitPrice*Quantity）合计大于20万欧元的国家，结果展示国家和销售额两个字段。

```sql
select Country,sum(UnitPrice*Quantity) as sales from ecommerce
group by Country
having sales > 200000
```

执行结果：

| Country        | sales              |
| -------------- | ------------------ |
| United Kingdom | 8187806.364001113  |
| Netherlands    | 284661.54000000015 |
| Germany        | 221698.20999999862 |
| EIRE           | 263276.81999999826 |

解释：我们使用`group by`按国家进行分组，对合计函数`sum`添加大于20万条件时，不能使用`where`子句，而是需要使用`having`子句，这一点初学者容易混淆。

**练习10**

在ecommerce表中，求销售额（UnitPrice*Quantity）合计大于Germany销售额的国家，结果展示国家和销售额两个字段。

```sql
select Country,sum(UnitPrice*Quantity) as sales from ecommerce
group by Country
having sales >
		(select sum(UnitPrice*Quantity)
		from ecommerce
		where Country='Germany');
```

解释：这道题目和练习9基本是一模一样的，唯一的区别是上题给出了销售额要大于20万欧元这个具体的数字，而本题只是把20万欧元替换成德国（Germany）的销售额。因此我们只需要先写一个查询出德国销售额的`select`子句，判断销售额合计数（sales）大于它。可以看出，“复杂语句”仅仅是将简单语句的一些值、表或条件用简单语句组合起来，可以借鉴中学时代学习物理的整体法思想，将一个语句看成一个整体，将其视作一个值，嵌套在上一层语句中。

