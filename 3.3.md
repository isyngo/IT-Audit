## 3.3 接口测试

我们在审计一家企业的时候，最终是对企业的财务数据、财务报表发表意见。而这些财务数据不是凭空产生的，它是对企业日常业务数据的反映，一些企业业务数据到财务数据的流转仅发生在ERP内部，也就是说数据是在一个系统内部流转，在数据库层面，同一个数据可能在唯一数据库中。更多的情况是企业除了ERP外，还有很多业务系统，数据的流转会经过多个业务系统最终进入ERP中，体现在我们的财务账里。

例如：之前笔者做过一家自来水公司的IT审计，公司抄表员每两个月上门用手持机抄表，每天将手持机的数据导入营销系统，营销系统的数据每天凌晨同步到收费系统，公司财务每月根据收费系统的汇总数据做账。我们可以看到整个数据流转过程为：手持机->营销系统->收费系统->财务系统。除了最后一步收费系统->财务系统是人工控制外，其余都是自动控制。理论上我们应该对整个数据流转的过程进行测试，也就是A系统数据流转到B系统数据是否是完全一致的，这里的“一致”是指数据的完整性和准确性，流转过程中是否有缺失、增加或数值的篡改。

数据在系统间的流转一般是通过接口实时传输或者在固定的时间批处理。我们对这样通过接口传输数据称之为“接口测试”。而对于不是开发该系统的人员来说，接口传输逻辑或者批处理脚本逻辑我们是不清楚的。我们要测试接口传输的准确性，不可能去查看别人系统代码，因此我们只能通过比较两个系统背后的数据库中的数据比对，来间接完成接口测试。而这样一种方法往往比较直接有效，如果企业的系统上线前没有经过严格的测试，往往数据传输会有一些bug，我们通过数据的直接比对就可以发现。

下面我们通过[Kaggle](https://www.kaggle.com/jr2ngb/superstore-data/data)网站上的公开数据“superstore_data”，来演示接口测试中需要使用的SQL语句。读者将本节的附件导入数据库中，表名命名为“store”。该数据为电商零售2011-2015年数据，下一节我们会详细列示数据中字段的含义，本节我们只需要知道，“Order ID”为订单号，“Sales”为订单销售额。

我们假设这张表数据为电商系统数据库中的数据，为了模拟一个流转到财务系统的数据，我们复制表中的“Order ID”和“Sales”两个字段为新表“store_plus”：

```sql
drop table if exists store_plus;
create table store_plus as
(
	select  `Order ID`,Sales
	from store
);
```

解释：`drop table if exists store_plus;`作用是如果已存在表`store_plus`就删除表，这句可以不用，但如果我们创建表后发现有错误，又需要修改语句重新执行的时候，必须删除表后才能创建，那么这条语句就比较有用。`create table store_plus as (查询语句)`是将括号内的查询语句结果保存在新创建的表`store_plus`中。执行后，我们模拟的财务系统中的表`store_plus`就包含了`Order ID`和`Sales`两个字段。我们需要对这两个字段和电商系统中的表`store`对应字段进行比对。

**完整性测试**

```sql
select a.`Order ID`,b.`Order ID`
from store a left join store_plus b 
on a.`Order ID`=b.`Order ID`
where b.`Order ID` is null
union
select a.`Order ID`,b.`Order ID`
from store a right join store_plus b 
on a.`Order ID`=b.`Order ID`
where a.`Order ID` is null
```

该语句是利用了2.5节中`join`的知识，以销售订单号为对象，查询两个数据集合的差集，也就是说可以查找出所有一张表中有而另外一张表中没有的销售订单号，从而完成完整性的测试。本节中的数据量比较小，只有11.4M，如果我们比对的数据有几个G，那么这样不做处理的查询会十分耗时，这时读者可以按照2.8节中讲解的索引相关知识，对销售订单号添加索引，可以大大提高查询速度。

**准确性测试**

在保证两张表的订单号是完全一致的情况下，我们就需要对每一个订单的销售额进行比对，查看金额是否准确。

```sql
select a.`Order ID`,a.Sales,b.sales,a.Sales-b.Sales
from (
			select `Order ID`,sum(Sales) as Sales
			from store group by `Order ID`) a 
join 
		(
			select `Order ID`,sum(Sales) as Sales
		  from store_plus group by `Order ID`) b
on a.`Order ID`=b.`Order ID`
where (a.Sales-b.Sales)<>0
```

原本我们可以直接使用`from store a join store_plus b`将两将表通过销售订单号内连接起来，但是存在一个订单号有多个商品，也就是说订单号会重复出现。所以我们通过`group by`先分别将两张表按销售订单号进行汇总，用每个订单的销售额相互比对，找出所有订单销售额不一致的订单。如果数据量比较大，也可以先将按订单汇总的数据创建表，然后再比对。除了比对订单销售额外，也可以比对其他重要的字段，这里不再赘述。

以上我们通过实际数据进行了接口测试的完整性和准确性两项分析。通常，财务审计可能会对业务系统和财务系统的“总数”进行核对，这样能够从总体上发现问题，但这样也可能有一些不足：

1. 未对数据流转的整个链条测试，只是局部的两个系统汇总数测试。
2. 数据颗粒度太大。当数据颗粒度太大的时候，就像一张不清晰的照片，一些关键的信息会消失。比如，汇总数可能是由方向相反的数据相加得到，如果方向相反的数据是不合理的，我们不能发现。
3. 若汇总数有差异，我们只能发现问题，并不能追踪问题的原因。而采用订单号颗粒度核对，我们发现问题后，能够根据单号追溯问题的原因。